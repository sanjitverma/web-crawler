<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Re: File lock problem in custom Maven Reporting Plugin</title>
  <link rel="stylesheet" type="text/css" href="/archives/style.css" />
 </head>

 <body id="archives">
  <h1>maven-users mailing list archives</h1>

  <h5>
<a href="http://mail-archives.apache.org/mod_mbox/" title="Back to the archives depot">Site index</a> &middot; <a href="/mod_mbox/maven-users" title="Back to the list index">List index</a></h5>  <table class="static" id="msgview">
   <thead>
    <tr>
    <th class="title">Message view</th>
    <th class="nav"><a href="/mod_mbox/maven-users/201212.mbox/%3cB26932F6490597418DC2917CFBC6787363A24F0D@suhn-mbx2.SIX3.local%3e" title="Previous by date">&laquo;</a> <a href="/mod_mbox/maven-users/201212.mbox/date" title="View messages sorted by date">Date</a> <a href="/mod_mbox/maven-users/201212.mbox/%3c50D3660A.3000501@artifact-software.com%3e" title="Next by date">&raquo;</a> &middot; <a href="/mod_mbox/maven-users/201212.mbox/%3cCAPoyBqQx8tQxvQNnJYkjEGow=j5D=08cvsf9fW2hf4HX6BzKkA@mail.gmail.com%3e" title="Previous by thread">&laquo;</a> <a href="/mod_mbox/maven-users/201212.mbox/thread" title="View messages sorted by thread">Thread</a> <a href="/mod_mbox/maven-users/201212.mbox/%3cOF3B419BAE.EB6EFFD0-ON65257AD2.001C7E4A-65257AD2.001DB55B@tcs.com%3e" title="Next by thread">&raquo;</a></th>
   </tr>
   </thead>

   <tfoot>
    <tr>
    <th class="title"><a href="#archives">Top</a></th>
    <th class="nav"><a href="/mod_mbox/maven-users/201212.mbox/%3cB26932F6490597418DC2917CFBC6787363A24F0D@suhn-mbx2.SIX3.local%3e" title="Previous by date">&laquo;</a> <a href="/mod_mbox/maven-users/201212.mbox/date" title="View messages sorted by date">Date</a> <a href="/mod_mbox/maven-users/201212.mbox/%3c50D3660A.3000501@artifact-software.com%3e" title="Next by date">&raquo;</a> &middot; <a href="/mod_mbox/maven-users/201212.mbox/%3cCAPoyBqQx8tQxvQNnJYkjEGow=j5D=08cvsf9fW2hf4HX6BzKkA@mail.gmail.com%3e" title="Previous by thread">&laquo;</a> <a href="/mod_mbox/maven-users/201212.mbox/thread" title="View messages sorted by thread">Thread</a> <a href="/mod_mbox/maven-users/201212.mbox/%3cOF3B419BAE.EB6EFFD0-ON65257AD2.001C7E4A-65257AD2.001DB55B@tcs.com%3e" title="Next by thread">&raquo;</a></th>
   </tr>
   </tfoot>

   <tbody>
   <tr class="from">
    <td class="left">From</td>
    <td class="right">Baptiste Gaillard &lt;baptiste.gaill...@gomoob.com&gt;</td>
   </tr>
   <tr class="subject">
    <td class="left">Subject</td>
    <td class="right">Re: File lock problem in custom Maven Reporting Plugin</td>
   </tr>
   <tr class="date">
    <td class="left">Date</td>
    <td class="right">Thu, 20 Dec 2012 19:02:34 GMT</td>
   </tr>
   <tr class="contents"><td colspan="2"><pre>
Hi Olivier,

I've created a JIRA issue here
http://jira.codehaus.org/browse/MSHARED-269with two project used to
reproduce the problem.

Thanks for the help guys,

Baptiste

2012/12/19 Olivier Lamy &lt;olamy@apache.org&gt;

&gt; Can you create a jira entry with a sample ?
&gt;
&gt; 2012/12/18 Baptiste Gaillard &lt;baptiste.gaillard@gomoob.com&gt;:
&gt; &gt; Hi and thanks for the response,
&gt; &gt;
&gt; &gt; My Mojo already overwrites the isExternalReport() function and returns
&gt; true
&gt; &gt; into it.
&gt; &gt;
&gt; &gt; To deep a little more I've tried to debug the execution of the Mojo when
&gt; &gt; running a 'mvn site' command using that Mojo.
&gt; &gt;
&gt; &gt; It seems that the function 'executeReport' associated to a reporting Mojo
&gt; &gt; is called before 'isExternalReport' is used.
&gt; &gt;
&gt; &gt; The 'execute' method associated to the 'AbstractMavenReport' (I'm using
&gt; &gt; 'maven-reporting-impl' version 2.2)   class contains the following lines
&gt; :
&gt; &gt;
&gt; &gt;         Writer writer = null;
&gt; &gt;         try
&gt; &gt;         {
&gt; &gt;             File outputDirectory = new File( getOutputDirectory() );
&gt; &gt;
&gt; &gt;             String filename = getOutputName() + ".html";
&gt; &gt;
&gt; &gt;             Locale locale = Locale.getDefault();
&gt; &gt;
&gt; &gt;             SiteRenderingContext siteContext = new
&gt; SiteRenderingContext();
&gt; &gt;             siteContext.setDecoration( new DecorationModel() );
&gt; &gt;             siteContext.setTemplateName(
&gt; &gt; "org/apache/maven/doxia/siterenderer/resources/default-site.vm" );
&gt; &gt;             siteContext.setLocale( locale );
&gt; &gt;
&gt; &gt;             RenderingContext context = new RenderingContext(
&gt; &gt; outputDirectory, filename );
&gt; &gt;
&gt; &gt;             SiteRendererSink sink = new SiteRendererSink( context );
&gt; &gt;
&gt; &gt;             generate( sink, null, locale );
&gt; &gt;
&gt; &gt; ...
&gt; &gt;
&gt; &gt; The 'generate' function then calls the reporting mojo 'executeReport'
&gt; &gt; function, so I think my locking problems comes from one of the following
&gt; &gt; calls :
&gt; &gt;     - 'new RenderingContext'
&gt; &gt;     - 'new SiteRendererSink'
&gt; &gt;
&gt; &gt; Do you have any other ideas ?
&gt; &gt;
&gt; &gt; Perhaps I should post this message on the developer Mailing List, my
&gt; &gt; problems seems to be linked to what Maven (or the 'maven-reporting-impl
&gt; &gt; plugin executes internally ?
&gt; &gt;
&gt; &gt; Thanks,
&gt; &gt;
&gt; &gt; Baptiste
&gt; &gt;
&gt; &gt; 2012/12/16 Robert Scholte &lt;rfscholte@apache.org&gt;
&gt; &gt;
&gt; &gt;&gt; This is probably what you need:
&gt; &gt;&gt; from org.apache.maven.reporting.**MavenReport.isExternalReport()
&gt; &gt;&gt;
&gt; &gt;&gt;     /**
&gt; &gt;&gt;      * An external report is a report which calls a third party program
&gt; &gt;&gt; which generates some reports too.
&gt; &gt;&gt;      * A good example is javadoc tool.
&gt; &gt;&gt;      *
&gt; &gt;&gt;      * @return &lt;tt&gt;true&lt;/tt&gt; if this report is external, &lt;tt&gt;false&lt;/tt&gt;
&gt; &gt;&gt; otherwise.
&gt; &gt;&gt;      * Default should be &lt;tt&gt;false&lt;/tt&gt;.
&gt; &gt;&gt;      */
&gt; &gt;&gt;     boolean isExternalReport();
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; Op Tue, 11 Dec 2012 23:42:43 +0100 schreef Baptiste Gaillard &lt;
&gt; &gt;&gt; baptiste.gaillard@gomoob.com&gt;**:
&gt; &gt;&gt;
&gt; &gt;&gt;  Hi, I'm currently creating a new Maven Reporting Plugin which
&gt; integrate an
&gt; &gt;&gt;&gt; external tool used to generate a Javascript documentation in my Maven
&gt; Web
&gt; &gt;&gt;&gt; Site.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; My report Mojo is very simple and is declared using :
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; /**
&gt; &gt;&gt;&gt;  * @goal jsduck
&gt; &gt;&gt;&gt;  * @phase site
&gt; &gt;&gt;&gt;  */
&gt; &gt;&gt;&gt; public class JSDuckReportMojo extends AbstractMavenReport {
&gt; &gt;&gt;&gt; ...
&gt; &gt;&gt;&gt; }
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I encounter a file locking problem (i.e already opened elsewhere and
&gt; not
&gt; &gt;&gt;&gt; closed) at the beginning of my 'executeReport' method :
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; *
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; protected void executeReport(Locale locale) throws
&gt; MavenReportException {
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;     // JSDuck creates an 'index.html' file itself and crashes if one
&gt; file
&gt; &gt;&gt;&gt; with this name already exist
&gt; &gt;&gt;&gt;     File jsduckIndex = new File("target/site/jsduck/**index.html");
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;     if (jsduckIndex.exists() &amp;&amp; !jsduckIndex.delete()) {
&gt; &gt;&gt;&gt;         throw new MavenReportException("Fail to delete the previously
&gt; &gt;&gt;&gt; generated index.html !"
&gt; &gt;&gt;&gt; );
&gt; &gt;&gt;&gt;     }
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;     // Use a document generator which absolutly need to have an empty
&gt; &gt;&gt;&gt; target directory
&gt; &gt;&gt;&gt;     ...
&gt; &gt;&gt;&gt; }
&gt; &gt;&gt;&gt; *
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; The tool I'm integrating is called 'jsduck' and absolutely needs to
&gt; have
&gt; &gt;&gt;&gt; an
&gt; &gt;&gt;&gt; empty target directory to work, its root index file is called
&gt; &gt;&gt;&gt; 'index.html'.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; So I've also implemented the 'getOutputName' function :
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; public String getOutputName() {
&gt; &gt;&gt;&gt; return "jsduck/index";
&gt; &gt;&gt;&gt; }
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; But, the file 'target/site/jsduck/index.**html' has already been
&gt; created
&gt; &gt;&gt;&gt; automagically by Maven.
&gt; &gt;&gt;&gt; In the 'executeReport' this file is there, empty and locked !
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; So, I can't delete this 'index.html' file and let JSDuck create itself
&gt; :-(
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Is it normal that Maven locks this 'index.html' file (because it has
&gt; been
&gt; &gt;&gt;&gt; declared in the 'getOutputName()' ) ?
&gt; &gt;&gt;&gt; How can I unlock this file inside the 'executeReport' function to let
&gt; &gt;&gt;&gt; JSDuck generate my documentation ?
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I've already tried to debug the 'AbstractMavenReport' class and only
&gt; found
&gt; &gt;&gt;&gt; a 'PrintWriter' attached to the 'Sink' (in the 'execute' method) which
&gt; &gt;&gt;&gt; could cause this locking problem.
&gt; &gt;&gt;&gt; Calling the 'close' method at the beginning of the 'executeReport'
&gt; method
&gt; &gt;&gt;&gt; seems to have no effect...
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Thanks for you help,
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Baptiste
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; ------------------------------**------------------------------**---------
&gt; &gt;&gt; To unsubscribe, e-mail: users-unsubscribe@maven.**apache.org&lt;
&gt; users-unsubscribe@maven.apache.org&gt;
&gt; &gt;&gt; For additional commands, e-mail: users-help@maven.apache.org
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; --
&gt; &gt;
&gt; &gt; *Baptiste GAILLARD*
&gt; &gt; *Mobile : +33(6) 85 12 81 26  &lt;http://
&gt; +33%286%29%2085%2012%2081%2026%20/&gt;*
&gt; &gt; *Mail     :* *baptiste.gaillard@gomoob.com*
&gt; &gt; *http://www.gomoob.com*
&gt; &gt; *
&gt; &gt; *
&gt; &gt; **
&gt; &gt; *
&gt; &gt; *
&gt;
&gt;
&gt;
&gt; --
&gt; Olivier Lamy
&gt; Talend: http://coders.talend.com
&gt; http://twitter.com/olamy | http://linkedin.com/in/olamy
&gt;
&gt; ---------------------------------------------------------------------
&gt; To unsubscribe, e-mail: users-unsubscribe@maven.apache.org
&gt; For additional commands, e-mail: users-help@maven.apache.org
&gt;
&gt;


-- 

*Baptiste GAILLARD*
*Mobile : +33(6) 85 12 81 26  &lt;http://+33%286%29%2085%2012%2081%2026%20/&gt;*
*Mail     :* *baptiste.gaillard@gomoob.com*
*http://www.gomoob.com*
*
*
**
*
*

</pre></td></tr>
   <tr class="mime">
    <td class="left">Mime</td>
    <td class="right">
<ul>
<li>Unnamed multipart/alternative (inline, None, 0 bytes)</li>
<ul>
<li><a rel="nofollow" href="/mod_mbox/maven-users/201212.mbox/raw/%3cCAF+yAzf1QM_3272eeNFQZwRB1ydj16q4zj9xBC-4L+KUJ9Drww@mail.gmail.com%3e/1">Unnamed text/plain</a> (inline, None, 6282 bytes)</li>
</ul>
</ul>
</td>
</tr>
   <tr class="raw">
    <td class="left"></td>
    <td class="right"><a href="/mod_mbox/maven-users/201212.mbox/raw/%3cCAF+yAzf1QM_3272eeNFQZwRB1ydj16q4zj9xBC-4L+KUJ9Drww@mail.gmail.com%3e" rel="nofollow">View raw message</a></td>
   </tr>
   </tbody>
  </table>
 </body>
</html>
