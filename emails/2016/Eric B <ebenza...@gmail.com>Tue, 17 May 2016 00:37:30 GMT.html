<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>How can I define the classloader for maven-antrun-plugin task?</title>
  <link rel="stylesheet" type="text/css" href="/archives/style.css" />
 </head>

 <body id="archives">
  <h1>maven-users mailing list archives</h1>

  <h5>
<a href="http://mail-archives.apache.org/mod_mbox/" title="Back to the archives depot">Site index</a> &middot; <a href="/mod_mbox/maven-users" title="Back to the list index">List index</a></h5>  <table class="static" id="msgview">
   <thead>
    <tr>
    <th class="title">Message view</th>
    <th class="nav"><a href="/mod_mbox/maven-users/201605.mbox/%3cCY1PR02MB2044F2EDFCF09793214BCD2FF2770@CY1PR02MB2044.namprd02.prod.outlook.com%3e" title="Previous by date">&laquo;</a> <a href="/mod_mbox/maven-users/201605.mbox/date" title="View messages sorted by date">Date</a> <a href="/mod_mbox/maven-users/201605.mbox/%3c1463470091628-5868525.post@n5.nabble.com%3e" title="Next by date">&raquo;</a> &middot; <a href="/mod_mbox/maven-users/201605.mbox/%3cCY1PR02MB2044F2EDFCF09793214BCD2FF2770@CY1PR02MB2044.namprd02.prod.outlook.com%3e" title="Previous by thread">&laquo;</a> <a href="/mod_mbox/maven-users/201605.mbox/thread" title="View messages sorted by thread">Thread</a> <a href="/mod_mbox/maven-users/201605.mbox/%3ccb45e20b14534d54a7d687c8c1aad1b1@VFLON-XCHMBX3.virtuefusion.corp%3e" title="Next by thread">&raquo;</a></th>
   </tr>
   </thead>

   <tfoot>
    <tr>
    <th class="title"><a href="#archives">Top</a></th>
    <th class="nav"><a href="/mod_mbox/maven-users/201605.mbox/%3cCY1PR02MB2044F2EDFCF09793214BCD2FF2770@CY1PR02MB2044.namprd02.prod.outlook.com%3e" title="Previous by date">&laquo;</a> <a href="/mod_mbox/maven-users/201605.mbox/date" title="View messages sorted by date">Date</a> <a href="/mod_mbox/maven-users/201605.mbox/%3c1463470091628-5868525.post@n5.nabble.com%3e" title="Next by date">&raquo;</a> &middot; <a href="/mod_mbox/maven-users/201605.mbox/%3cCY1PR02MB2044F2EDFCF09793214BCD2FF2770@CY1PR02MB2044.namprd02.prod.outlook.com%3e" title="Previous by thread">&laquo;</a> <a href="/mod_mbox/maven-users/201605.mbox/thread" title="View messages sorted by thread">Thread</a> <a href="/mod_mbox/maven-users/201605.mbox/%3ccb45e20b14534d54a7d687c8c1aad1b1@VFLON-XCHMBX3.virtuefusion.corp%3e" title="Next by thread">&raquo;</a></th>
   </tr>
   </tfoot>

   <tbody>
   <tr class="from">
    <td class="left">From</td>
    <td class="right">Eric B &lt;ebenza...@gmail.com&gt;</td>
   </tr>
   <tr class="subject">
    <td class="left">Subject</td>
    <td class="right">How can I define the classloader for maven-antrun-plugin task?</td>
   </tr>
   <tr class="date">
    <td class="left">Date</td>
    <td class="right">Tue, 17 May 2016 00:37:30 GMT</td>
   </tr>
   <tr class="contents"><td colspan="2"><pre>
I recently posted this on StackOverflow, but I've had no traction to the
question there at all.  I'm hoping that this list will have a bit more
feedback for me.

I'm having some significant issues converting an ant build to a maven build
due to an ant task that does not exist as a plugin. The AntTask is part of
the defunct Kodo persistence library (JDO) that is used to byte enhance the
entities.

In the build.xml, I have the following target defined:

  &lt;/taskdef&gt;
  &lt;kodoc directory="${compile.dir}"&gt;
     &lt;classpath refid="compiled.classpath"/&gt;
     &lt;fileset dir="${compile.dir}"&gt;
     &lt;include name="**/*.jdo"/&gt;
     &lt;/fileset&gt;
  &lt;/kodoc&gt;

where ${compile.dir} is defined as the directory where javac compiles its
files, and compiled.classpath is a list of all libs, etc that are required
for the plugin.

I have translated that to the following maven-antrun-plugin definition:

        &lt;plugin&gt;
            &lt;artifactId&gt;maven-antrun-plugin&lt;/artifactId&gt;
            &lt;version&gt;1.8&lt;/version&gt;
            &lt;dependencies&gt;
            ... list of all the dependencies required for the plugin to run ...
            &lt;/dependencies&gt;
            &lt;executions&gt;
                &lt;execution&gt;
                    &lt;id&gt;kodo&lt;/id&gt;
                    &lt;goals&gt;
                        &lt;goal&gt;run&lt;/goal&gt;
                    &lt;/goals&gt;
                    &lt;phase&gt;compile&lt;/phase&gt;
                    &lt;configuration&gt;
                        &lt;target&gt;
                                &lt;fileset id="jdo-files"
dir="${project.build.outputDirectory}"&gt;
                                    &lt;include name="**/*.jdo" /&gt;
                                &lt;/fileset&gt;

                            &lt;path id="myclasspath"&gt;
                                &lt;path refid="maven.compile.classpath" /&gt;
                                &lt;path refid="maven.plugin.classpath"/&gt;
                            &lt;/path&gt;


                            &lt;taskdef name="kodoc"
classname="kodo.ant.PCEnhancerTask" classpathref="myclasspath" &gt;
                            &lt;/taskdef&gt;

                            &lt;kodoc
directory="${project.build.outputDirectory}"
classpath="${project.build.outputDirectory}" &gt;
                                &lt;fileset refid="jdo-files"/&gt;
                            &lt;/kodoc&gt;
                        &lt;/target&gt;
                    &lt;/configuration&gt;
                &lt;/execution&gt;
            &lt;/executions&gt;
        &lt;/plugin&gt;

I would have thought it would work the same. And generally speaking, it
seems to. It finds all the required dependencies and is able to run.

Except in one spot.

In the AntTask definition, there is the following code:

ClassLoader loader = getClass().getClassLoader();
loader.getResource(rsrc);

where the getClass().getClassLoader() is inspected via a debugger to be:

ClassRealm[plugin&gt;org.apache.maven.plugins:maven-antrun-plugin:1.8,
parent: sun.misc.Launcher$AppClassLoader@18b4aac2]

and rsrc points to a filename that is found in /src/main/resources, or more
specifically in target/classes.

However, when the loader tries to load rsrc, it fails to find the file, as
the AntRun classloader has no visibility on that folder.

When I debug the same task in a true Ant call (not maven), I see the
classloader as being:

AntClassLoader[C:\dev\Projects\jigger\jigger_ejb\dist\compile;C:\dev\Projects\jigger\lib_ext\kodo4\jdo.jar;C:\dev\Projects\jigger\lib_ext\kodo4\jpa.jar;C:\dev\Projects\jigger\lib_ext\kodo4\kodo-api.jar;......
all the libs in the ${compiled.classpath} var]

Which has a true visibility on the compile (ie: target/classes) folder, and
hence is able to load the required resource.

Modifying the AntTask is not really an option or particularly desired.

Is there anyway I can specify a different classloader to the
maven-antrun-plugin such that it is able to load/find my resource? I've
tried all the possible combinations I can think of, but no matter which
classpath I indicate to the task, the classloader always remains the same -
the antrun classloader which has no visibility on my target folder.

Baring that, is there any other option I have to make this work??
Thanks,

Eric

</pre></td></tr>
   <tr class="mime">
    <td class="left">Mime</td>
    <td class="right">
<ul>
<li>Unnamed multipart/alternative (inline, None, 0 bytes)</li>
<ul>
<li><a rel="nofollow" href="/mod_mbox/maven-users/201605.mbox/raw/%3cCA+T+PjGUj_FFFjf1n2A4Jb8+immr807MY81TMWtEFCSstKKNAA@mail.gmail.com%3e/1">Unnamed text/plain</a> (inline, None, 4097 bytes)</li>
</ul>
</ul>
</td>
</tr>
   <tr class="raw">
    <td class="left"></td>
    <td class="right"><a href="/mod_mbox/maven-users/201605.mbox/raw/%3cCA+T+PjGUj_FFFjf1n2A4Jb8+immr807MY81TMWtEFCSstKKNAA@mail.gmail.com%3e" rel="nofollow">View raw message</a></td>
   </tr>
   </tbody>
  </table>
 </body>
</html>
